{% extends 'base.html' %}

{% block title %}Admin Dashboard - Aptitude Test Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h4>
            </div>
            <div class="card-body">
                <h5>Welcome, {{ session.username }}!</h5>
                <p>From here, you can manage tests, view results, and manage admin users.</p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <a href="{{ url_for('create_test') }}" class="btn btn-success">
                        <i class="fas fa-plus-circle me-2"></i>Create New Test/Quiz
                    </a>
                    {% if session.username == 'admin' %}
                    <a href="{{ url_for('manage_admins') }}" class="btn btn-primary">
                        <i class="fas fa-users-cog me-2"></i>Manage Admins
                    </a>
                    {% endif %}
                    <a href="{{ url_for('reset_password') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-key me-2"></i>Reset Password
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-7">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Your Tests</h5>
            </div>
            <div class="card-body">
                {% if tests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Duration</th>
                                    <th>Created On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in tests %}
                                    <tr>
                                        <td>{{ test[1] }}</td>
                                        <td>{{ test[2] }} minutes</td>
                                        <td>{{ test[5] }}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button type="button" class="btn" style="border: 1px solid var(--primary); color: var(--primary);" title="View Results">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                                <button type="button" class="btn" style="border: 1px solid var(--warning); color: var(--warning);" title="Edit Test">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form method="POST" action="{{ url_for('delete_test', test_id=test[0]) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this test? This action cannot be undone.')">
                                                    <button type="submit" class="btn" style="border: 1px solid var(--danger); color: var(--danger);" title="Delete Test">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>You haven't created any tests yet.
                    </div>
                    <div style="text-align: center; display: flex; justify-content: center;">
                        <a href="{{ url_for('create_test') }}" class="btn" style="background-color: var(--primary); color: white;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Create Test/Quiz
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-5">
        <div class="card">
            <div class="card-header" style="background-color: var(--info); color: white; display: flex; justify-content: space-between; align-items: center;">
                <h5 style="margin: 0;"><i class="fas fa-chart-line me-2"></i>Recent Test Results</h5>
                <a href="{{ url_for('export_results') }}" class="btn" title="Export to Excel" style="background-color: white; color: var(--info); border: 1px solid var(--info); font-size: 0.875rem; padding: 0.25rem 0.5rem;">
                    <i class="fas fa-file-excel" style="margin-right: 0.25rem;"></i>Export
                </a>
            </div>
            <div class="card-body">
                {% if results %}
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e9ecef;">
                                    <th style="padding: 0.75rem; text-align: left;">User</th>
                                    <th style="padding: 0.75rem; text-align: left;">Test</th>
                                    <th style="padding: 0.75rem; text-align: left;">Score</th>
                                    <th style="padding: 0.75rem; text-align: left;">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 0.75rem;">{{ result.username }}</td>
                                        <td style="padding: 0.75rem;">{{ result.test_name }}</td>
                                        <td style="padding: 0.75rem;">
                                            <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500; color: white; background-color: {% if result.percentage >= 70 %}var(--success){% elif result.percentage >= 40 %}var(--warning){% else %}var(--danger){% endif %};">
                                                {{ result.percentage }}%
                                            </span>
                                        </td>
                                        <td>{{ result.formatted_date }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No test results available yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Analytics Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stat-card p-3">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-clipboard-list fa-2x text-primary"></i>
                            </div>
                            <h3>{{ tests|length }}</h3>
                            <p class="mb-0">Tests Created</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card p-3">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-users fa-2x text-success"></i>
                            </div>
                            <h3>{{ results|length }}</h3>
                            <p class="mb-0">Tests Taken</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card p-3">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-check-circle fa-2x text-info"></i>
                            </div>
                            <h3>
                                {% set passing = 0 %}
                                {% for result in results if result.percentage >= 60 %}
                                    {% set passing = passing + 1 %}
                                {% endfor %}
                                {{ passing }}
                            </h3>
                            <p class="mb-0">Passing Results</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card p-3">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                            <h3>
                                {{ warnings|length }}
                            </h3>
                            <p class="mb-0">Cheating Warnings</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}