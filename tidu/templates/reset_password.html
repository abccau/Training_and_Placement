{% extends 'base.html' %}

{% block title %}Reset Password - Aptitude Test Platform{% endblock %}

{% block content %}
<div style="display: flex; justify-content: center;">
    <div style="width: 100%; max-width: 600px;">
        <div class="card">
            <div class="card-header" style="background-color: var(--primary); color: white;">
                <h4 style="margin: 0;"><i class="fas fa-key me-2"></i>Reset Password</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('reset_password_submit') }}" id="resetPasswordForm">
                    <div style="margin-bottom: 1rem;">
                        <label for="username" style="display: block; margin-bottom: 0.5rem;">Username</label>
                        <input type="text" class="form-input" id="username" name="username" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="email" style="display: block; margin-bottom: 0.5rem;">Email</label>
                        <input type="email" class="form-input" id="email" name="email" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="user_type" style="display: block; margin-bottom: 0.5rem;">Account Type</label>
                        <select class="form-select" id="user_type" name="user_type" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="new_password" style="display: block; margin-bottom: 0.5rem;">New Password</label>
                        <div style="display: flex;">
                            <input type="password" class="form-input" id="new_password" name="new_password" style="flex: 1;" required>
                            <button class="btn" style="border: 1px solid #ccc; background: none; margin-left: -1px;" type="button" data-target="new_password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div style="height: 5px; background-color: #e9ecef; margin-top: 0.5rem;">
                            <div id="password-strength" style="height: 100%; width: 0%; background-color: var(--primary);"></div>
                        </div>
                        <small id="password-feedback" style="color: #6c757d; font-size: 0.875rem;">Password strength</small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="confirm_password" style="display: block; margin-bottom: 0.5rem;">Confirm New Password</label>
                        <div style="display: flex;">
                            <input type="password" class="form-input" id="confirm_password" name="confirm_password" style="flex: 1;" required>
                            <button class="btn" style="border: 1px solid #ccc; background: none; margin-left: -1px;" type="button" data-target="confirm_password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="password-match-feedback" style="font-size: 0.875rem;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        {% if user_type == 'admin' %}
                        <a href="{{ url_for('admin_dashboard') }}" class="btn" style="border: 1px solid var(--secondary); color: var(--secondary);">Cancel</a>
                        {% else %}
                        <a href="{{ url_for('user_dashboard') }}" class="btn" style="border: 1px solid var(--secondary); color: var(--secondary);">Cancel</a>
                        {% endif %}
                        <button type="submit" class="btn" style="background-color: var(--primary); color: white;" id="submitBtn">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
        
        // Password strength meter
        const passwordInput = document.getElementById('new_password');
        const strengthBar = document.getElementById('password-strength');
        const strengthFeedback = document.getElementById('password-feedback');
        
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength += 25;
            if (password.match(/[a-z]+/)) strength += 25;
            if (password.match(/[A-Z]+/)) strength += 25;
            if (password.match(/[0-9]+/) || password.match(/[^a-zA-Z0-9]+/)) strength += 25;
            
            strengthBar.style.width = strength + '%';
            strengthBar.setAttribute('aria-valuenow', strength);
            
            if (strength < 25) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthFeedback.textContent = 'Very Weak';
                strengthFeedback.className = 'form-text text-danger';
            } else if (strength < 50) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthFeedback.textContent = 'Weak';
                strengthFeedback.className = 'form-text text-warning';
            } else if (strength < 75) {
                strengthBar.className = 'progress-bar bg-info';
                strengthFeedback.textContent = 'Moderate';
                strengthFeedback.className = 'form-text text-info';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthFeedback.textContent = 'Strong';
                strengthFeedback.className = 'form-text text-success';
            }
        });
        
        // Password match validation
        const confirmPasswordInput = document.getElementById('confirm_password');
        const matchFeedback = document.getElementById('password-match-feedback');
        const submitBtn = document.getElementById('submitBtn');
        
        function checkPasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword === '') {
                matchFeedback.textContent = '';
                matchFeedback.className = 'form-text';
                return;
            }
            
            if (password === confirmPassword) {
                matchFeedback.textContent = 'Passwords match';
                matchFeedback.className = 'form-text text-success';
                submitBtn.disabled = false;
            } else {
                matchFeedback.textContent = 'Passwords do not match';
                matchFeedback.className = 'form-text text-danger';
                submitBtn.disabled = true;
            }
        }
        
        passwordInput.addEventListener('input', checkPasswordMatch);
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        
        // Form validation
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        
        resetPasswordForm.addEventListener('submit', function(e) {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const newPassword = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (!username || !email || !newPassword || !confirmPassword) {
                e.preventDefault();
                alert('Please fill in all fields.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('New passwords do not match.');
                return;
            }
            
            if (newPassword.length < 8) {
                e.preventDefault();
                alert('New password must be at least 8 characters long.');
                return;
            }
        });
    });
</script>
{% endblock %}